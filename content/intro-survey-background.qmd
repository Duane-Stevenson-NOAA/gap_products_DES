---
title: Survey Background
---

```{r setup, include=FALSE}
#| file: functions.R
```

## What is the research objective?

The objectives of these surveys are to:

-   monitor trends in the marine ecosystem of the Bering Sea, Aleutian Islands, and Gulf of Alaska
-   produce fishery-independent biomass and abundance estimates for commercially important fish and crab species
-   collect biological and environmental data for use in ecosystem-based fishery management.

Learn more about the [program](https://www.fisheries.noaa.gov/alaska/science-data/groundfish-assessment-program-bottom-trawl-surveys)

![Sorting and weighing fish on deck on the 2022 Bering Sea groundfish survey aboard the F/V Alaska Knight. Credit: Emily Markowitz/NOAA Fisheries.](https://www.fisheries.noaa.gov/s3/2023-04/750x500-bottom-trawl-survey-afsc.jpg)


## Bottom trawl surveys and regions

```{r survey-map, echo=FALSE, results='asis'}
knitr::include_graphics(path = here::here("img", "survey_plot.png"))
```

```{r source-current-tm, echo=FALSE}
# source("https://raw.githubusercontent.com/afsc-gap-products/citations/main/cite/current_data_tm.r")
srvy_cite <- data.frame(
  SRVY = c("EBS", "NBS", "GOA", "AI", "BSS"),
  CITE = c("2022NEBS2023", "2022NEBS2023","GOA2018", "AI2018", "RN979"))
```


```{r}
#| tbl-cap: Survey summary stats
#| message: false
#| warning: false
#| echo: false

# - **Aleutian Islands (AI)** [@`r srvy_cite$CITE[srvy_cite$SRVY == "AI"]`]
#   - Triennial (1990s)/Biennial since 2000 in even years
#   - Modified Index-Stratified Random of Successful Stations Survey Design
# - **Eastern Bering Sea Slope (BSS)** [@`r srvy_cite$CITE[srvy_cite$SRVY == "BSS"]`]
#   - Intermittent (funding dependent)
#   - Modified Index-Stratified Random of Successful Stations Survey Design
# - **Eastern Bering Sea Shelf (EBS)** [@`r srvy_cite$CITE[srvy_cite$SRVY == "EBS"]`]
#   - Annual
#   - Fixed stations at center of 20 x 20 nm grid
# - **Gulf of Alaska (GOA)** [@`r srvy_cite$CITE[srvy_cite$SRVY == "GOA"]`]
#   - Triennial (1990s)/Biennial since 2001 in odd years
#   - Stratified Random Survey Design
# - **Northern Bering Sea (NBS)** [@`r srvy_cite$CITE[srvy_cite$SRVY == "NBS"]`]
#   - Biennial/Annual
#   - Fixed stations at center of 20 x 20 nm grid

dat_cruise <- RODBC::sqlQuery(channel = channel, 
                       query = 
"SELECT 
SURVEY_DEFINITION_ID, 
SURVEY_NAME, 
YEAR
FROM GAP_PRODUCTS.AKFIN_CRUISE cc") %>% 
  dplyr::left_join(y = data.frame(SURVEY_DEFINITION_ID = c(98, 143, 47, 52, 78), 
                                  SRVY = c("EBS", "NBS", "GOA", "AI", "BSS"))) %>% 
  dplyr::filter(!is.na(SRVY)) %>% 
  dplyr::distinct() %>%
                     dplyr::group_by(SRVY, SURVEY_DEFINITION_ID, SURVEY_NAME) %>% 
                     dplyr::summarise(YEARS = n(), 
                                      YEAR_S = max(YEAR, na.rm = T), 
                                      YEAR_E = min(YEAR, na.rm = T)) %>% 
                     unique()#)


dat_stratum <- RODBC::sqlQuery(channel = channel, 
                       query = 
"SELECT 
SURVEY_DEFINITION_ID, 
AREA_KM2, 
DESIGN_YEAR, 
DEPTH_MIN_M, 
DEPTH_MAX_M 
FROM GAP_PRODUCTS.AREA ss")  %>% 
  dplyr::left_join(y = data.frame(SURVEY_DEFINITION_ID = c(98, 143, 47, 52, 78), 
                                  SRVY = c("EBS", "NBS", "GOA", "AI", "BSS"))) %>% 
  dplyr::filter(!is.na(SRVY)) %>% 
      dplyr::group_by(SRVY, DESIGN_YEAR) %>%
      dplyr::summarise(STRATUM = n(), 
                       AREA_KM2 = sum(AREA_KM2, na.rm = TRUE), 
                       DEPTH_MIN_M = min(DEPTH_MIN_M, na.rm = TRUE), 
                       DEPTH_MAX_M = max(DEPTH_MAX_M, na.rm = TRUE)) %>% 
  dplyr::filter(!is.na(SRVY) & 
                  DESIGN_YEAR %in% max(DESIGN_YEAR)) %>% 
  dplyr::select(-DESIGN_YEAR)


dat_station <- RODBC::sqlQuery(channel = channel, 
                       query = 
"SELECT 
SRVY, 
STATION, 
DESIGN_YEAR
FROM GAP_PRODUCTS.OLD_STATION ss")  %>% 
  dplyr::left_join(y = data.frame(SURVEY_DEFINITION_ID = c(98, 143, 47, 52, 78), 
                                  SRVY = c("EBS", "NBS", "GOA", "AI", "BSS"))) %>% 
  dplyr::filter(!is.na(SURVEY_DEFINITION_ID)) %>% 
      dplyr::group_by(SRVY, DESIGN_YEAR) %>%
      dplyr::summarise(STATION = n()) %>% 
    dplyr::select(-DESIGN_YEAR)

table_raw <- dplyr::full_join(dat_stratum, dat_station) %>% 
  dplyr::full_join(dat_cruise) %>% 
    dplyr::ungroup()  %>% 
  dplyr::left_join(y = srvy_cite, 
                   by = "SRVY")%>%
  dplyr::mutate(Years = paste0(YEAR_S, " - ", YEAR_E, " (", YEARS, ")"), 
                area = paste0(formatC(x = AREA_KM2, format = "f", big.mark = ",", digits = 1)), 
                depth = paste0(formatC(x = DEPTH_MIN_M, format = "f", big.mark = ",", digits = 0), 
                               " - ", 
                               formatC(x = DEPTH_MAX_M, format = "f", big.mark = ",", digits = 0)), 
                Design = dplyr::case_when(
                  SRVY == "AI" ~ "Triennial (1990s)/Biennial since 2000 in even years; Modified Index-Stratified Random of Successful Stations Survey Design", 
                SRVY == "BSS" ~ "Intermittent (funding dependent); Modified Index-Stratified Random of Successful Stations Survey Design", 
                SRVY == "EBS" ~ "Annual; Fixed stations at center of 20 x 20 nm grid", 
                SRVY == "NBS" ~ "Biennial/Annual; Fixed stations at center of 20 x 20 nm grid", 
                SRVY == "GOA" ~ "Triennial (1990s)/Biennial since 2001 in odd years; Stratified Random Survey Design"), 
                CITE = paste0("@", CITE)) %>% 
  dplyr::select(SURVEY_NAME, SURVEY_DEFINITION_ID, Years, depth, area, STRATUM, STATION, Citation = CITE, Design)

table_print <- table_raw %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(
    SURVEY_NAME = "Survey", 
    SURVEY_DEFINITION_ID = "Survey Definition ID", 
    depth = "Depth (m)", 
    area = "Area (km2)", 
    STRATUM = "# Statistical Areas", 
    STATION = "# Possible Stations" ) %>% 
    theme_flextable_nmfstm(x = ., 
                           font0 = "Arial", 
                           pad = 0, 
                           row_lines = FALSE, 
                           pgwidth = 8) %>% 
  flextable::fit_to_width(x = ., max_width = 11) %>%
  flextable::padding(padding = 5) %>% 
  flextable::theme_zebra() %>% 
    flextable::align(x = ., part = "body", align = "center", j = "SURVEY_DEFINITION_ID") %>% 
  flextable::width(j = "SURVEY_NAME", width = 1.5) %>%
  ftExtra::colformat_md()

table_print 
```


## Survey Strata

Stratum numbers in the AKFIN tables designate different levels of data grouping. These designations are different for the different surveys (EBS slope vs EBS shelf). Given that these groupings are made at different levels, care should be taken not to sum values over all strata because this can duplicate data.

### Aleutian Islands Survey


### Northern Bering Sea Survey


### Eastern Bering Sea Survey

```{r srvy-bg-ebs, echo=FALSE}
#| label: srvy-bg-ebs
#| fig-cap: "Strata used in the Eastern Bering Sea Survey. "

knitr::include_graphics(path = here::here("img", "ebs-strata.png"))
```

Strata include (1, 2, 3, 4, 5, 6, 8, 9, 10, 20, 31, 32, 41, 42, 43, 50, 61, 62, 82, 90, 100, 200, 300, 999).
Strata 10, 20, 31, 32, 41, 42, 43, 50, 61, 62, 82, 90 are the core strata within which biomass and population are computed. The other strata (1,2,3,4,5,6,8,9, 100,200,300, 999) are various summations of the core strata, as follows:
1 = 10
2 = 20
3 = 31+32
4 = 41+42+43
5 = 50
6 = 61+62
8 = 82
9 = 90
100 = depth zone <50 m (=strata 1+2; or 10+20)
200 = depth zone 50-100 m (=strata 3+4+8; or 31+32+41+42+43+82)
300 = depth zone 100-200 m (=strata 5+6+9; or 50+61+90)
999 = overall combined (=all strata= 1+2+3+4+5+6+8+9; or 10+20+31+32+41+42+43+50+61+62+82+90)

### Bering Sea Slope Survey

```{r srvy-bg-bss, echo=FALSE}
#| label: srvy-bg-bss
#| fig-cap: "Strata used in the Bering Sea Slope Survey. "

knitr::include_graphics(path = here::here("img", "bss-strata.png"))
```

Strata include (1, 2, 3, 4, 5, 6, 11, 12, 13, 14, 15, 21, 22, 23, 24, 25, 31, 32, 33, 34, 35, 41, 42, 43, 44, 45, 51, 52, 53, 54, 55, 61, 62, 63, 64, 65, 999999).
 
For 1-digit “strata”, the digit designates the Canyons ordered 1 - 6 , south to north, as follows:
1 =  Bering Canyon
2 = Pribilof Canyon
3 = Inter Pribilof-Zhemchug
4 = Zhemchug Canyon
5 = Inter Zhemchug-Pervenets
6 = Navarin/Pervenets Canyons
For 2-digit “strata”, the 1st digit designates the slope Canyon as above, and the 2nd digit designates the depth zone grouped into 200 m ranges as follows:
2nd digit:
1 =  200-400 m depth zone
2 =  400-600 m depth zone
3 =  600-800 m depth zone
4 =  800-1000 m depth zone
5 =  1000-1200 m depth zone
 
Thus, for example:
Stratum    1 =  Bering Canyon, all depths within that Canyon
Stratum    2 = Pribilof Canyon, all depths within that Canyon
Stratum  11 = Bering Canyon at depths of 200-400 m
Stratum  65 = Navarin/Pervenets Canyons at depths of 1000-1200 m
Finally, there is a combined overall Stratum designation:
999999 = all Canyons over all depth zones
Thus, biomass for stratum=999999 is the same as the sum of biomass for strata 1+2+3+4+5+6, or the sum of biomass for strata (11+12+13+14+15+21+22+23+24+25+31+32+33+34+35+41+42+43+44+45+51+52+53+54+55+61+62+63+64+65).

### Gulf of Alaska Survey





