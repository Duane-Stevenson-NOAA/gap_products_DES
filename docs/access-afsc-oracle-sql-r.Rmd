---
title: 'Access public data using R in Oracle (AFSC only)'
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  md_document: 
    variant: gfm
csl: "https://raw.githubusercontent.com/citation-style-language/styles/master/apa-no-ampersand.csl"
bibliography: "https://raw.githubusercontent.com/afsc-gap-products/citations/main/cite/bibliography.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, message = FALSE)
library(ggplot2)
```

> [Return to main page](https://afsc-gap-products.github.io/gap_public_data/)

## Access data via Oracle

If the user has access to the AFSC `Oracle` database, the user can use `SQL developer` to view and pull the FOSS public data directly from the `RACEBASE_FOSS` `Oracle` schema. 

### Connect to Oracle from R

Many users will want to access the data from `Oracle` using `R`. The user will need to install the `RODBC` `R` package and ask OFIS (IT) connect `R` to `Oracle`. Then, use the following code in `R` to establish a connection from `R` to `Oracle`: 

Here, the user can write in their username and password directly into the `RODBC` connect function. Never save usernames or passwords in scripts that may be intentionally or unintentionally shared with others. If no username and password is entered in the function, pop-ups will appear on the screen asking for the username and password. 

# Connect to Oracle from R

## Access data via Oracle

If the user has access to the AFSC `Oracle` database, the user can use `SQL developer` to view and pull the GAP Products data directly from the `GAP_PRODUCTS` `Oracle` schema. 

### Connect to Oracle from R

Many users will want to access the data from `Oracle` using `R`. The user will need to install the `RODBC` `R` package and ask OFIS (IT) connect `R` to `Oracle`. Then, use the following code in `R` to establish a connection from `R` to `Oracle`: 

Here, the user can write in their username and password directly into the `RODBC` connect function. Never save usernames or passwords in scripts that may be intentionally or unintentionally shared with others. If no username and password is entered in the function, pop-ups will appear on the screen asking for the username and password. 

```{r oracle-connect-2, echo = TRUE, eval = FALSE}
#' Define RODBC connection to ORACLE
#'
#' @param schema default = 'AFSC'. 
#'
#' @return oracle channel connection
#' @export
#'
#' @examples
#' # Not run
#' # channel <- oracle_connect()
oracle_connect <- function(
    schema='AFSC', 
    username = NULL, 
    passowrd = NULL){(echo=FALSE)
  
  library("RODBC")
  library("getPass")
  if (is.null(username)) {
    username <- getPass(msg = "Enter your ORACLE Username: ")
  }
  if (is.null(password)) {
    password <- getPass(msg = "Enter your ORACLE Password: ")
  }
  channel  <- RODBC::odbcConnect(
    paste(schema),
    paste(username),
    paste(password), 
    believeNRows=FALSE)
  return(channel)
}

channel <- oracle_connect()
```

### Select all data

Once connected, pull and save the tables of interest into the `R` environment. 

```{r oracle-data-pull, echo = TRUE, eval = FALSE}
# Pull table from oracle into R environment
cpue <- RODBC::sqlQuery(channel, "SELECT * FROM GAP_PRODUCTS.CPUE")
# Save table to local directory
write.csv(x = cpue, file = "GAP_PRODUCTS-CPUE.csv")
```

# Data SQL Query Examples: 

### Biomass and abundance for Pacific Ocean perch from 1990 – 2023 for the western/central/eastern GOA management areas as well as for the entire region. 

```{r sql-1, connection = channel}
dat <- RODBC::sqlQuery(channel = channel, 
                     query = "WITH FILTERED_STRATA AS (
SELECT AREA_ID, DESCRIPTION FROM GAP_PRODUCTS.AREA
WHERE TYPE in ('REGULATORY AREA', 'REGION') AND  SURVEY_DEFINITION_ID = 47)
SELECT *
FROM GAP_PRODUCTS.BIOMASS BIOMASS
JOIN FILTERED_STRATA STRATA ON STRATA.AREA_ID = BIOMASS.AREA_ID
WHERE BIOMASS.SURVEY_DEFINITION_ID IN 47 AND BIOMASS.SPECIES_CODE = 30060")
flextable::flextable(head(dat))
```

### Northern and Southern rock sole size composition data from 1991 – 2022 for the Aleutian Islands

```{r  sql-2, connection = channel}
dat <- RODBC::sqlQuery(channel = channel, 
                     query = "WITH FILTERED_STRATA AS (
  SELECT AREA_ID, DESCRIPTION FROM GAP_PRODUCTS.AREA
  WHERE TYPE = 'REGION' AND SURVEY_DEFINITION_ID = 52)
SELECT * 
FROM GAP_PRODUCTS.SIZECOMP SIZECOMP
JOIN FILTERED_STRATA STRATA ON STRATA.AREA_ID = SIZECOMP.AREA_ID
WHERE SIZECOMP.SURVEY_DEFINITION_ID IN 52 AND SIZECOMP.SPECIES_CODE IN (10261, 10262)")
flextable::flextable(head(dat))
```

### Walleye pollock age composition for the EBS Standard Area from 1982 – 2022 and the EBS + NW Area from 1987 – 2022

```{r  sql-3, connection = channel}
dat <- RODBC::sqlQuery(channel = channel, 
                     query = "WITH FILTERED_STRATA AS (
  SELECT AREA_ID, DESCRIPTION FROM GAP_PRODUCTS.AREA
  WHERE TYPE = 'REGION' AND SURVEY_DEFINITION_ID = 98)
SELECT * 
 FROM GAP_PRODUCTS.AGECOMP AGECOMP
 JOIN FILTERED_STRATA STRATA ON STRATA.AREA_ID = AGECOMP.AREA_ID
 WHERE SURVEY_DEFINITION_ID = 98 AND SPECIES_CODE = 21740")
flextable::flextable(head(dat))
```

### Pacific cod biomass and abundance data for the NBS by stratum for 2022. 

```{r  sql-4, connection = channel}
dat <- RODBC::sqlQuery(channel = channel, 
                     query = "WITH FILTERED_STRATA AS (
SELECT AREA_ID, AREA_NAME, DESCRIPTION FROM GAP_PRODUCTS.AREA
WHERE TYPE in ('STRATUM') AND SURVEY_DEFINITION_ID = 143) 
SELECT *
FROM GAP_PRODUCTS.BIOMASS BIOMASS 
JOIN FILTERED_STRATA STRATA ON STRATA.AREA_ID = BIOMASS.AREA_ID
WHERE BIOMASS.SURVEY_DEFINITION_ID IN 143 AND BIOMASS.SPECIES_CODE = 21720")
flextable::flextable(head(dat))
```

## Pacific Ocean Perch biomass totals for GOA between 1984-2021 from `GAP_PRODUCTS.BIOMASS`

```{r query-biomass}
#| tbl-cap: POP biomass totals for GOA between 1984-2021 from `GAP_PRODUCTS.BIOMASS`. 

dat <- RODBC::sqlQuery(channel, 
                     "SELECT * FROM GAP_PRODUCTS.BIOMASS
WHERE SPECIES_CODE = 30060 
AND SURVEY_DEFINITION_ID = 47 
AND AREA_ID = 99903 
AND YEAR BETWEEN 1984 AND 2021;") %>% 
  janitor::clean_names()

dim(dat)
flextable::flextable(head(dat))
```

```{r r-plot-biomass-mean}
#| fig-cap: Plot of POP biomass totals for GOA between 1984-2021 from `GAP_PRODUCTS.BIOMASS`. 

a_mean <- dat %>% 
  dplyr::group_by(survey_definition_id) %>% 
  dplyr::summarise(biomass_mt = mean(biomass_mt, na.rm = TRUE), 
                   minyr = min(year, na.rm = TRUE), 
                   maxyr = max(year, na.rm = TRUE)) 

figure <-
  ggplot(data = dat, 
         mapping = aes(x = year, 
                       y = biomass_mt)) +
  geom_point(size = 1.5) + 
  ggplot2::scale_x_continuous(labels = scales::label_number(
    accuracy = 1, big.mark = ""))   +
  geom_segment(data = a_mean,
               mapping = aes(x = minyr, 
                             xend = maxyr, 
                             y = biomass_mt, 
                             yend = biomass_mt),
               linetype = "dashed", size = 1) +
  ggplot2::ggtitle(label = "GOA Pacific Ocean Perch Biomass 1984-2021", 
                   subtitle = paste0("Mean = ", 
                                     formatC(x = a_mean$biomass_mt, digits = 2, big.mark = ",", format = "f"), " mt")) +
  ggplot2::xlab(label = "Year") +
  ggplot2::ylab(label = "Biomass (mt)") +
  ggplot2::theme_bw()

figure

```

```{r child-footer, child=here::here("docs","footer.Rmd")}
```

